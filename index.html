<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•¸å­¸2ä½æ¸›æ³•æ¨‚åœ’</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons (Global Variable: lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Framer Motion (Global Variable: Motion) -->
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    
    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body {
            font-family: 'Nunito', 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
            overflow-x: hidden;
        }
        /* Shake Animation */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .animate-shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        
        /* Custom Range Slider */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            margin-top: -8px; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- Libraries Handling ---
        const { useState, useEffect, useRef } = React;
        const { 
            Home, ArrowLeft, ShoppingBag, Package, Play,
            Smile, ShieldAlert, Check, Volume2, VolumeX,
            Users, X, Edit3, ArrowRight, Coffee, CheckCircle2, ArrowUp, Type
        } = lucide.icons;

        // Custom Component for Lucide Icons
        const Icon = ({ name, size = 24, className = "", ...props }) => {
            return <i data-lucide={name.toLowerCase().replace(/([a-z0-9])([A-Z])/g, '$1-$2')} className={className} style={{width: size, height: size, display: 'inline-block'}}></i>;
        };

        // Framer Motion Wrapper
        const { motion, AnimatePresence } = Motion;

        // Hook to refresh icons
        const useLucide = () => {
            useEffect(() => {
                lucide.createIcons();
            });
        };

        // --- GLOBAL CONFIG & DATA ---
        const COLORS = {
            story: 'bg-indigo-50 text-indigo-900',
            burger: 'bg-orange-50 text-orange-900',
            success: 'bg-green-500',
            white: 'bg-white',
            primary: 'bg-blue-500',
            danger: 'bg-red-500'
        };

        const CATEGORIES = [
            {
                id: 'basic',
                name: 'åŸºç¤ï¼šä¸éœ€å€Ÿä½',
                desc: 'å€‹ä½æ•¸å¤ æ¸›ï¼Œç›´æ¥ç®—ï¼',
                levels: [
                    { min: 45, sub: 3 }, { min: 67, sub: 2 }, { min: 89, sub: 4 }, { min: 52, sub: 1 },
                    { min: 38, sub: 5 }, { min: 76, sub: 6 }, { min: 91, sub: 0 }, { min: 27, sub: 3 },
                    { min: 64, sub: 2 }, { min: 55, sub: 4 }, { min: 83, sub: 1 }, { min: 75, sub: 5 }, 
                    { min: 49, sub: 7 }, { min: 66, sub: 3 }, { min: 98, sub: 6 }
                ]
            },
            {
                id: 'borrow_1',
                name: 'é€²éšï¼šéœ€å€Ÿä½',
                desc: 'å€‹ä½æ•¸ä¸å¤ æ¸›ï¼Œè¦å€Ÿä½ï¼',
                levels: [
                    { min: 52, sub: 7 }, { min: 63, sub: 8 }, { min: 41, sub: 5 }, { min: 70, sub: 9 },
                    { min: 84, sub: 6 }, { min: 25, sub: 9 }, { min: 33, sub: 7 }, { min: 90, sub: 8 },
                    { min: 61, sub: 4 }, { min: 57, sub: 9 }, { min: 42, sub: 8 }, { min: 75, sub: 6 },
                    { min: 80, sub: 3 }, { min: 68, sub: 9 }, { min: 53, sub: 5 }
                ]
            },
            {
                id: 'basic_2',
                name: 'å…©ä½æ•¸æ¸›æ³• (ä¸å€Ÿä½)',
                desc: 'å…ˆæ¸›å€‹ä½ï¼Œå†æ¸›åä½ï¼',
                levels: [
                    { min: 87, sub: 35 }, { min: 96, sub: 42 }, { min: 75, sub: 21 }, { min: 68, sub: 34 },
                    { min: 59, sub: 27 }, { min: 84, sub: 53 }, { min: 92, sub: 61 }, { min: 77, sub: 46 },
                    { min: 63, sub: 20 }, { min: 55, sub: 32 }, { min: 88, sub: 57 }, { min: 99, sub: 78 },
                    { min: 70, sub: 30 }, { min: 81, sub: 40 }, { min: 66, sub: 25 }
                ]
            },
            {
                id: 'borrow_2',
                name: 'å…©ä½æ•¸æ¸›æ³• (éœ€å€Ÿä½)',
                desc: 'å€Ÿä½è®Šèº«ï¼Œé‚„è¦æ¸›æ‰åä½ï¼',
                levels: [
                    { min: 52, sub: 37 }, { min: 63, sub: 28 }, { min: 81, sub: 45 }, { min: 74, sub: 59 },
                    { min: 90, sub: 67 }, { min: 45, sub: 29 }, { min: 62, sub: 38 }, { min: 80, sub: 43 },
                    { min: 71, sub: 56 }, { min: 53, sub: 47 }, { min: 95, sub: 78 }, { min: 64, sub: 49 },
                    { min: 87, sub: 69 }, { min: 70, sub: 52 }, { min: 58, sub: 39 }
                ]
            }
        ];

        // Audio Manager
        const audioManager = {
            isMuted: false,
            speak: (text) => {
                if (audioManager.isMuted) return;
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const u = new SpeechSynthesisUtterance(text);
                    u.lang = 'zh-HK';
                    u.rate = 0.9;
                    u.pitch = 1.1;
                    window.speechSynthesis.speak(u);
                }
            },
            playSound: (type) => {
                if (audioManager.isMuted) return;
                // Simple placeholder for sound effects
            }
        };

        // --- SHARED COMPONENTS ---

        const MainMenu = ({ onSelect }) => {
            useLucide();
            return (
                <div className="min-h-screen bg-slate-50 p-6 flex flex-col items-center justify-center font-sans">
                    <motion.div 
                        initial={{ y: -50, opacity: 0 }}
                        animate={{ y: 0, opacity: 1 }}
                        className="text-center mb-10"
                    >
                        <h1 className="text-5xl font-black text-slate-800 mb-4 tracking-tight">æ•¸å­¸2ä½æ¸›æ³•æ¨‚åœ’ ğŸ¢</h1>
                        <p className="text-slate-500 text-xl font-bold">ä»Šå¤©æƒ³ç”¨ä»€éº¼æ–¹å¼å­¸æ¸›æ³•ï¼Ÿ</p>
                    </motion.div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-4xl">
                        {/* Story Mode */}
                        <motion.button
                            whileHover={{ scale: 1.05, y: -10 }}
                            whileTap={{ scale: 0.95 }}
                            onClick={() => {
                                audioManager.speak("æ•¸å­—æ•‘æ´éšŠ");
                                onSelect('story');
                            }}
                            className="h-80 rounded-[2rem] shadow-xl flex flex-col items-center justify-between p-8 text-white bg-indigo-500 border-indigo-700 border-b-8 relative overflow-hidden group"
                        >
                            <div className="bg-white/20 p-6 rounded-full backdrop-blur-sm shadow-inner mt-2">
                                <Icon name="Users" size={48} />
                            </div>
                            <div className="text-center z-10">
                                <span className="inline-block px-3 py-1 bg-black/20 rounded-full text-sm font-bold mb-2 backdrop-blur-md">æ•…äº‹æ¨¡å¼</span>
                                <h2 className="text-3xl font-black mb-2 shadow-sm">æ•¸å­—æ•‘æ´éšŠ</h2>
                                <p className="text-white/90 text-lg font-medium leading-relaxed">ä¿è­·å°å…µï¼æŠŠæ€ªç¸è¶•èµ°ï¼</p>
                            </div>
                            <div className="bg-white/20 px-6 py-2 rounded-full font-bold text-sm flex items-center gap-2">
                                <Icon name="Play" size={16} fill="currentColor" /> é–‹å§‹éŠæˆ²
                            </div>
                        </motion.button>

                        {/* Burger Mode */}
                        <motion.button
                            whileHover={{ scale: 1.05, y: -10 }}
                            whileTap={{ scale: 0.95 }}
                            onClick={() => {
                                audioManager.speak("å¿«æ¨‚æ¼¢å ¡åº—");
                                onSelect('burger');
                            }}
                            className="h-80 rounded-[2rem] shadow-xl flex flex-col items-center justify-between p-8 text-white bg-orange-500 border-orange-700 border-b-8 relative overflow-hidden group"
                        >
                            <div className="bg-white/20 p-6 rounded-full backdrop-blur-sm shadow-inner mt-2">
                                <Icon name="ShoppingBag" size={48} />
                            </div>
                            <div className="text-center z-10">
                                <span className="inline-block px-3 py-1 bg-black/20 rounded-full text-sm font-bold mb-2 backdrop-blur-md">è·æ¥­æ¨¡æ“¬</span>
                                <h2 className="text-3xl font-black mb-2 shadow-sm">å¿«æ¨‚æ¼¢å ¡åº—</h2>
                                <p className="text-white/90 text-lg font-medium leading-relaxed">ç•¶å€‹å¥½åº—é•·ï¼æº–å‚™æ¼¢å ¡å’Œæ¬é‹ç®±å­ï¼</p>
                            </div>
                            <div className="bg-white/20 px-6 py-2 rounded-full font-bold text-sm flex items-center gap-2">
                                <Icon name="Play" size={16} fill="currentColor" /> é–‹å§‹éŠæˆ²
                            </div>
                        </motion.button>
                    </div>
                </div>
            );
        };

        const LevelSelector = ({ color, onBack, onLevelSelect, onCustom }) => {
            useLucide();
            return (
                <div className={`min-h-screen ${color} p-6 flex flex-col items-center justify-center`}>
                    <div className="w-full max-w-5xl flex items-center mb-8 relative">
                        <button onClick={onBack} className="absolute left-0 p-3 bg-white rounded-full shadow-lg text-slate-600 hover:bg-slate-50">
                            <Icon name="ArrowLeft" size={32} />
                        </button>
                        <h1 className="text-4xl font-black text-center w-full text-slate-800">é¸æ“‡ç·´ç¿’é—œå¡</h1>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-5xl">
                        {CATEGORIES.map((cat) => (
                            <button 
                                key={cat.id}
                                onClick={() => onLevelSelect(cat)}
                                className="bg-white p-8 rounded-3xl shadow-lg border-4 border-white/50 hover:border-white hover:scale-[1.02] transition-all flex flex-col items-start gap-3 group text-left h-full"
                            >
                                <div className="flex items-center gap-4 w-full">
                                    <div className={`p-4 rounded-2xl ${cat.id.includes('basic') ? 'bg-green-100 text-green-600' : 'bg-orange-100 text-orange-600'}`}>
                                        {cat.id.includes('basic') ? <Icon name="Smile" size={32} /> : <Icon name="ShieldAlert" size={32} />}
                                    </div>
                                    <div className="flex-1">
                                        <h2 className="text-2xl font-bold text-slate-800">{cat.name}</h2>
                                        <p className="text-slate-500 text-sm">{cat.desc}</p>
                                    </div>
                                </div>
                                <div className="flex gap-2 mt-2 flex-wrap">
                                    {cat.levels.slice(0, 5).map((l, i) => (
                                        <span key={i} className="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500">{l.min}-{l.sub}</span>
                                    ))}
                                    <span className="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500">...</span>
                                </div>
                            </button>
                        ))}

                        <button 
                            onClick={onCustom}
                            className="md:col-span-2 bg-white/50 p-6 rounded-3xl border-4 border-dashed border-slate-400 hover:bg-white hover:border-slate-500 transition-all flex items-center justify-center gap-4 text-slate-700 font-bold text-xl"
                        >
                            <Icon name="Edit3" /> æˆ‘è¦è‡ªè¨‚é¡Œç›® (Self-Study)
                        </button>
                    </div>
                </div>
            );
        };

        const CustomInput = ({ color, onBack, onStart }) => {
            useLucide();
            const [inputVal, setInputVal] = useState({ min: '', sub: '' });
            const [errorMsg, setErrorMsg] = useState('');

            const handleStart = () => {
                const min = parseInt(inputVal.min);
                const sub = parseInt(inputVal.sub);
                if (isNaN(min) || isNaN(sub)) { setErrorMsg("è«‹è¼¸å…¥æ•¸å­—å–”ï¼"); return; }
                if (min < 10 || min > 99) { setErrorMsg("è¢«æ¸›æ•¸è«‹è¼¸å…¥å…©ä½æ•¸"); return; }
                if (sub < 1 || sub >= min) { setErrorMsg("æ¸›æ•¸è¦æ¯”è¢«æ¸›æ•¸å°"); return; }
                onStart(min, sub);
            };

            return (
                <div className={`min-h-screen ${color} p-6 flex flex-col items-center justify-center`}>
                    <div className="bg-white w-full max-w-2xl p-10 rounded-[3rem] shadow-2xl border-8 border-white/50 relative">
                        <button onClick={onBack} className="absolute top-6 left-6 p-3 bg-slate-100 rounded-full text-slate-500">
                            <Icon name="ArrowLeft" />
                        </button>
                        <h2 className="text-3xl font-black text-center text-slate-800 mb-8">è‡ªè¨‚é¡Œç›®</h2>
                        
                        <div className="flex items-center justify-center gap-4 mb-8">
                            <input type="number" value={inputVal.min} onChange={(e) => setInputVal({...inputVal, min: e.target.value})} placeholder="75" className="w-40 h-24 text-5xl font-black text-center bg-slate-50 border-4 border-slate-200 rounded-2xl focus:border-blue-500 outline-none text-slate-800" />
                            <span className="text-6xl font-black text-slate-300">-</span>
                            <input type="number" value={inputVal.sub} onChange={(e) => setInputVal({...inputVal, sub: e.target.value})} placeholder="23" className="w-40 h-24 text-5xl font-black text-center bg-slate-50 border-4 border-slate-200 rounded-2xl focus:border-blue-500 outline-none text-red-500" />
                            <span className="text-6xl font-black text-slate-300">=</span>
                            <div className="w-24 h-24 flex items-center justify-center text-5xl font-black text-slate-400">?</div>
                        </div>
                        {errorMsg && <div className="bg-red-100 text-red-600 p-4 rounded-xl font-bold text-center mb-6">{errorMsg}</div>}
                        <button onClick={handleStart} className="w-full bg-blue-500 hover:bg-blue-600 text-white text-3xl font-bold py-6 rounded-2xl shadow-xl flex items-center justify-center gap-3">é–‹å§‹ <Icon name="ArrowRight" /></button>
                    </div>
                </div>
            );
        };

        // --- STORY GAME ---
        const StoryGame = ({ onBack, fontScale }) => {
            useLucide();
            const [mode, setMode] = useState('category');
            const [currentCategory, setCurrentCategory] = useState(null);
            const [currentLevelIndex, setCurrentLevelIndex] = useState(0);
            const [q, setQ] = useState(null); 
            const [step, setStep] = useState(1); 
            const [clickedSoldiers, setClickedSoldiers] = useState([]); 
            const [clickedGiants, setClickedGiants] = useState([]); 
            const [userAnswer, setUserAnswer] = useState('');
            const [isAnswerCorrect, setIsAnswerCorrect] = useState(null); 
            const inputRef = useRef(null);

            const startLevel = (min, sub) => {
                const minTens = Math.floor(min / 10);
                const minUnits = min % 10;
                const subTens = Math.floor(sub / 10);
                const subUnits = sub % 10;
                const borrow = minUnits < subUnits;
                setQ({ min, sub, minTens, minUnits, subTens, subUnits, borrow });
                setStep(1);
                setClickedSoldiers([]);
                setClickedGiants([]);
                setUserAnswer('');
                setIsAnswerCorrect(null);
                setMode('playing');
            };

            const handleNextLevel = () => {
                if (currentCategory && currentLevelIndex < currentCategory.levels.length - 1) {
                    const nextIndex = currentLevelIndex + 1;
                    setCurrentLevelIndex(nextIndex);
                    startLevel(currentCategory.levels[nextIndex].min, currentCategory.levels[nextIndex].sub);
                } else {
                    audioManager.speak("æ­å–œä½ ï¼é€™å€‹é¡åˆ¥å…¨éƒ¨é€šé—œäº†ï¼");
                    setMode('category');
                }
            };

            const checkUserAnswer = () => {
                if (!q) return;
                const correctAnswer = q.min - q.sub;
                if (parseInt(userAnswer) === correctAnswer) {
                    setIsAnswerCorrect(true);
                    setStep(8);
                    audioManager.playSound('success');
                    audioManager.speak(`ç­”å°äº†ï¼ç­”æ¡ˆå°±æ˜¯ ${correctAnswer}ï¼å¤ªæ£’äº†ï¼`);
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                } else {
                    setIsAnswerCorrect(false);
                    audioManager.playSound('error');
                    audioManager.speak("ç­”æ¡ˆä¸å¤ªå°å–”ï¼Œå†ç®—ä¸€æ¬¡çœ‹çœ‹ï¼");
                    setTimeout(() => setIsAnswerCorrect(null), 1500); 
                }
            };

            useEffect(() => {
                if (mode !== 'playing' || !q) return;
                const totalSoldiersStart = q.borrow ? (10 + q.minUnits) : q.minUnits;
                const answer = q.min - q.sub;

                if(step === 1) audioManager.speak(`é¡Œç›®æ˜¯ ${q.min} æ¸› ${q.sub}ã€‚æˆ‘å€‘æœ‰ ${q.minTens} å€‹å·¨äººå’Œ ${q.minUnits} å€‹å°å…µã€‚`);
                if(step === 2) {
                    if (q.borrow) audioManager.speak(`ç³Ÿç³•ï¼è¦è¶•èµ° ${q.subUnits} å€‹å°å…µï¼Œå¯æ˜¯åªæœ‰ ${q.minUnits} å€‹ï¼Œä¸å¤ æ¸›ï¼`);
                    else audioManager.speak(`è¦è¶•èµ° ${q.subUnits} å€‹å°å…µã€‚é€™è£¡æœ‰ ${q.minUnits} å€‹ï¼Œè¶³å¤ äº†ï¼`);
                }
                if(step === 3) audioManager.speak("å¿«é»å‘¼å«å·¨äººå“¥å“¥ä¾†å¹«å¿™ï¼");
                if(step === 4) audioManager.speak("é»ä¸€ä¸‹å·¨äººï¼Œè®“ä»–è®Šèº«æˆ 10 å€‹å°å…µï¼");
                if(step === 5) audioManager.speak(`è®Šèº«æˆåŠŸï¼ç¾åœ¨æœ‰ ${totalSoldiersStart} å€‹å°å…µäº†ï¼`);
                if(step === 6) audioManager.speak(`ç¾åœ¨ï¼Œè«‹ä½ é»æ“Š ${q.subUnits} å€‹å°å…µï¼ŒæŠŠä»–å€‘è¶•èµ°ï¼`);
                if(step === 7) audioManager.speak(`æ¥ä¸‹ä¾†ï¼Œè¦æ¸›æ‰ ${q.subTens} å€‹åä½æ•¸ã€‚è«‹é»æ“Š ${q.subTens} å€‹å·¨äººæŠŠä»–å€‘è¶•èµ°ï¼`);
                
                if ((step === 6 && clickedSoldiers.length === q.subUnits && q.subTens === 0) || 
                    (step === 7 && clickedGiants.length === q.subTens)) {
                    audioManager.speak("åšå¥½äº†ï¼ç¾åœ¨è«‹åœ¨ä¸Šé¢è¼¸å…¥ç­”æ¡ˆï¼");
                    if(inputRef.current) inputRef.current.focus();
                }

                if(step === 8 && !userAnswer) { 
                    audioManager.speak(`ç®—å‡ºä¾†äº†ï¼${q.min} æ¸› ${q.sub} ç­‰æ–¼ ${answer}ï¼ä»»å‹™å®Œæˆï¼`);
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                }
            }, [step, mode, q]);

            const handleSoldierClick = (id) => {
                if (step === 6 && clickedSoldiers.length < q.subUnits && !clickedSoldiers.includes(id)) {
                    setClickedSoldiers(prev => [...prev, id]);
                    audioManager.playSound('pop');
                    if (clickedSoldiers.length + 1 === q.subUnits) audioManager.speak(`å¤ªæ£’äº†ï¼Œè¶•èµ°äº† ${q.subUnits} å€‹å°å…µï¼`);
                }
            };

            const handleGiantClick = (id) => {
                if (step === 7 && clickedGiants.length < q.subTens && !clickedGiants.includes(id)) {
                    setClickedGiants(prev => [...prev, id]);
                    audioManager.playSound('thud');
                    if (clickedGiants.length + 1 === q.subTens) audioManager.speak(`è¶•èµ°äº† ${q.subTens} å€‹å·¨äººï¼`);
                }
            };

            if (mode === 'category') return <LevelSelector color={COLORS.story} onBack={onBack} onLevelSelect={(cat) => { setCurrentCategory(cat); setCurrentLevelIndex(0); startLevel(cat.levels[0].min, cat.levels[0].sub); }} onCustom={() => setMode('input')} />;
            if (mode === 'input') return <CustomInput color={COLORS.story} onBack={() => setMode('category')} onStart={(min, sub) => { setCurrentCategory(null); startLevel(min, sub); }} />;
            if (!q) return null;

            return (
                <div className={`min-h-screen ${COLORS.story} p-4 flex flex-col items-center relative overflow-hidden`}>
                    {/* Top Bar */}
                    <div className="w-full max-w-5xl flex justify-between items-center mb-6 z-10">
                        <button onClick={() => setMode('category')} className="p-3 bg-white rounded-full shadow-lg hover:bg-gray-100 transition"><Icon name="Home" className="text-indigo-600" /></button>
                        
                        <div className="bg-white px-6 py-2 rounded-full shadow-md border-2 border-indigo-200 flex items-center gap-3">
                            <span 
                                className="text-indigo-800 font-bold tracking-wide"
                                style={{ fontSize: `${1.5 * fontScale}rem` }}
                            >
                                <span className="text-indigo-600">{q.min}</span> - <span className="text-red-500">{q.sub}</span> = 
                            </span>
                            <div className="relative">
                                <input 
                                    ref={inputRef}
                                    type="number" 
                                    value={userAnswer}
                                    onChange={(e) => setUserAnswer(e.target.value)}
                                    onKeyDown={(e) => e.key === 'Enter' && checkUserAnswer()}
                                    disabled={step === 8}
                                    style={{ fontSize: `${1.5 * fontScale}rem`, width: `${6 * fontScale}rem`, height: `${3 * fontScale}rem` }}
                                    className={`text-center font-bold border-2 rounded-xl outline-none transition-all
                                        ${isAnswerCorrect === false ? 'border-red-500 bg-red-50 animate-shake' : 
                                        isAnswerCorrect === true ? 'border-green-500 bg-green-50' : 'border-indigo-300 focus:border-indigo-500'}
                                    `}
                                    placeholder="?"
                                />
                                {step === 8 && <div className="absolute right-[-40px] top-2"><Icon name="CheckCircle2" className="text-green-500" size={32} /></div>}
                            </div>
                            {step !== 8 && (
                                <button onClick={checkUserAnswer} className="bg-indigo-500 hover:bg-indigo-600 text-white p-2 rounded-lg transition-colors">
                                    <Icon name="Check" size={24} />
                                </button>
                            )}
                        </div>

                        <button onClick={() => audioManager.speak(`é¡Œç›®æ˜¯ ${q.min} æ¸› ${q.sub}`)} className="p-3 bg-white rounded-full shadow-lg hover:bg-gray-100 transition"><Icon name="Volume2" className="text-indigo-600" /></button>
                    </div>

                    <div className="flex-1 w-full max-w-4xl bg-white rounded-[3rem] shadow-2xl border-8 border-indigo-200 p-8 flex flex-col relative">
                        <h2 className="text-3xl font-black text-center text-indigo-900 mb-8">
                            {step === 6 ? `é»æ“Šè¶•èµ° ${q.subUnits} å€‹å°å…µï¼` : step === 7 ? `é»æ“Šè¶•èµ° ${q.subTens} å€‹å·¨äººï¼` : "æ•¸å­—æ•‘æ´éšŠ"}
                        </h2>

                        <div className="flex-1 flex flex-col justify-center gap-8">
                            {/* Tens Area */}
                            <div className="flex items-end gap-4 p-4 bg-indigo-50 rounded-3xl border-2 border-dashed border-indigo-300 relative min-h-[160px] flex-wrap content-end">
                                <span className="absolute top-2 left-4 text-indigo-400 font-bold text-sm">åä½æ•¸ (å·¨äºº)</span>
                                <AnimatePresence>
                                    {Array.from({ length: q.minTens }).map((_, i) => {
                                        const isBorrower = q.borrow && (i === q.minTens - 1);
                                        const isClicked = clickedGiants.includes(`g-${i}`);
                                        if (isBorrower && step >= 5) return null; 
                                        return (
                                            <motion.div key={`giant-${i}`} layoutId={isBorrower ? "giant-borrower" : undefined} className={`relative text-7xl transition-transform ${step === 7 && !isClicked && !isBorrower && clickedGiants.length < q.subTens ? 'cursor-pointer hover:scale-110' : ''}`} onClick={() => !isBorrower && handleGiantClick(`g-${i}`)}>
                                                {isBorrower && step === 4 ? <button onClick={() => setStep(5)} className="absolute inset-0 z-20 animate-bounce">ğŸ¦¸â€â™‚ï¸</button> : <span>ğŸ—¿</span>}
                                                {isClicked && <motion.div initial={{ opacity: 0, scale: 2 }} animate={{ opacity: 0.7, scale: 1 }} className="absolute inset-0 flex items-center justify-center text-red-600 font-bold"><Icon name="X" size={64} strokeWidth={4} /></motion.div>}
                                                <span 
                                                    className="absolute -bottom-8 left-1/2 -translate-x-1/2 text-indigo-300 font-bold pointer-events-none"
                                                    style={{ fontSize: `${1 * fontScale}rem` }}
                                                >
                                                    {i + 1}
                                                </span>
                                            </motion.div>
                                        );
                                    })}
                                </AnimatePresence>
                            </div>

                            {/* Units Area */}
                            <div className="flex items-center gap-2 p-4 bg-green-50 rounded-3xl border-2 border-dashed border-green-300 relative min-h-[160px] flex-wrap content-center">
                                <span className="absolute top-2 left-4 text-green-600 font-bold text-sm">å€‹ä½æ•¸ (å°å…µ)</span>
                                {Array.from({ length: q.minUnits }).map((_, idx) => {
                                    const id = `org-${idx}`;
                                    const isClicked = clickedSoldiers.includes(id);
                                    return (
                                        <motion.div key={id} className={`text-5xl relative ${step === 6 && !isClicked && clickedSoldiers.length < q.subUnits ? 'cursor-pointer hover:scale-110' : ''}`} onClick={() => handleSoldierClick(id)}>
                                            ğŸ‘¶
                                            {isClicked && <motion.div initial={{ opacity: 0, scale: 2 }} animate={{ opacity: 0.7, scale: 1 }} className="absolute inset-0 flex items-center justify-center text-red-600 font-bold"><Icon name="X" size={40} strokeWidth={4} /></motion.div>}
                                            <span 
                                                className="absolute -bottom-8 left-1/2 -translate-x-1/2 text-green-600 font-bold pointer-events-none"
                                                style={{ fontSize: `${1 * fontScale}rem` }}
                                            >
                                                {idx + 1}
                                            </span>
                                        </motion.div>
                                    );
                                })}
                                <AnimatePresence>
                                    {step >= 5 && q.borrow && (
                                        <motion.div initial={{ scale: 0 }} animate={{ scale: 1 }} className="flex flex-wrap gap-2 p-2 bg-yellow-100 rounded-2xl border-4 border-yellow-400">
                                            {Array.from({ length: 10 }).map((_, i) => {
                                                const id = `new-${i}`;
                                                const isClicked = clickedSoldiers.includes(id);
                                                return (
                                                    <motion.div key={id} className={`text-4xl relative ${step === 6 && !isClicked && clickedSoldiers.length < q.subUnits ? 'cursor-pointer hover:scale-110' : ''}`} onClick={() => handleSoldierClick(id)}>
                                                        ğŸ‘¶
                                                        {isClicked && <motion.div initial={{ opacity: 0, scale: 2 }} animate={{ opacity: 0.7, scale: 1 }} className="absolute inset-0 flex items-center justify-center text-red-600 font-bold"><Icon name="X" size={40} strokeWidth={4} /></motion.div>}
                                                        <span 
                                                            className="absolute -bottom-8 left-1/2 -translate-x-1/2 text-green-600 font-bold pointer-events-none"
                                                            style={{ fontSize: `${1 * fontScale}rem` }}
                                                        >
                                                            {q.minUnits + i + 1}
                                                        </span>
                                                    </motion.div>
                                                );
                                            })}
                                        </motion.div>
                                    )}
                                </AnimatePresence>
                            </div>
                        </div>

                        {/* Controls */}
                        <div className="mt-6 flex justify-center h-24">
                            {step === 1 && <button onClick={() => setStep(2)} className="bg-indigo-500 hover:bg-indigo-600 text-white text-2xl font-bold py-4 px-12 rounded-full shadow-xl">é–‹å§‹è§£é¡Œï¼</button>}
                            {step === 2 && (q.borrow ? <button onClick={() => setStep(3)} className="bg-red-500 hover:bg-red-600 text-white text-2xl font-bold py-4 px-12 rounded-full shadow-xl animate-pulse">ä¸å¤ æ¸›ï¼å‘¼å«å·¨äºº</button> : <button onClick={() => setStep(6)} className="bg-green-500 hover:bg-green-600 text-white text-2xl font-bold py-4 px-12 rounded-full shadow-xl">å¤ æ¸›ï¼ç›´æ¥è¶•å°å…µ</button>)}
                            {step === 3 && <button onClick={() => setStep(4)} className="bg-yellow-500 hover:bg-yellow-600 text-white text-2xl font-bold py-4 px-12 rounded-full shadow-xl">è«‹å·¨äººè®Šèº«</button>}
                            {(step === 4 || step === 5) && q.borrow && <button onClick={() => setStep(6)} className={`text-white text-2xl font-bold py-4 px-12 rounded-full shadow-xl ${step === 5 ? 'bg-orange-500 animate-bounce' : 'bg-gray-400 cursor-not-allowed'}`} disabled={step === 4}>{step === 4 ? "è«‹é»æ“Šå·¨äºº..." : "é–‹å§‹è¶•èµ°å°å…µ"}</button>}
                            
                            {step === 6 && (
                                <div className="flex flex-col items-center">
                                    <div className="text-xl font-bold text-indigo-800 mb-2 bg-indigo-100 px-4 py-1 rounded-full">å·²è¶•èµ°å°å…µ: {clickedSoldiers.length} / {q.subUnits}</div>
                                    {clickedSoldiers.length < q.subUnits ? (
                                        <div className="text-gray-400 font-bold animate-pulse text-xl">è«‹é»æ“Šå°å…µ...</div>
                                    ) : (
                                        q.subTens > 0 ? (
                                            <button onClick={() => setStep(7)} className="bg-green-500 hover:bg-green-600 text-white text-2xl font-bold py-3 px-12 rounded-full shadow-xl animate-bounce">æ¥è‘—æ¸›åä½æ•¸</button>
                                        ) : (
                                            <div className="flex flex-col items-center gap-2 animate-bounce">
                                                <Icon name="ArrowUp" size={40} className="text-purple-500" />
                                                <span className="text-2xl font-bold text-purple-600 bg-white px-4 py-2 rounded-xl shadow-md border-2 border-purple-200">è«‹åœ¨ä¸Šæ–¹è¼¸å…¥ç­”æ¡ˆï¼</span>
                                            </div>
                                        )
                                    )}
                                </div>
                            )}
                            
                            {step === 7 && (
                                <div className="flex flex-col items-center">
                                    <div className="text-xl font-bold text-indigo-800 mb-2 bg-indigo-100 px-4 py-1 rounded-full">å·²è¶•èµ°å·¨äºº: {clickedGiants.length} / {q.subTens}</div>
                                    {clickedGiants.length < q.subTens ? (
                                        <div className="text-gray-400 font-bold animate-pulse text-xl">è«‹é»æ“Šå·¨äºº...</div>
                                    ) : (
                                        <div className="flex flex-col items-center gap-2 animate-bounce">
                                            <Icon name="ArrowUp" size={40} className="text-purple-500" />
                                            <span className="text-2xl font-bold text-purple-600 bg-white px-4 py-2 rounded-xl shadow-md border-2 border-purple-200">è«‹åœ¨ä¸Šæ–¹è¼¸å…¥ç­”æ¡ˆï¼</span>
                                        </div>
                                    )}
                                </div>
                            )}

                            {step === 8 && <button onClick={handleNextLevel} className="bg-blue-500 hover:bg-blue-600 text-white text-2xl font-bold py-4 px-12 rounded-full shadow-xl flex items-center gap-2">{currentCategory ? "ä¸‹ä¸€é—œ" : "å†è©¦ä¸€é¡Œ"} <Icon name="ArrowRight" /></button>}
                        </div>
                    </div>
                </div>
            );
        };

        // --- BURGER GAME ---
        const BurgerGame = ({ onBack, fontScale }) => {
            useLucide();
            const [mode, setMode] = useState('category');
            const [currentCategory, setCurrentCategory] = useState(null);
            const [currentLevelIndex, setCurrentLevelIndex] = useState(0);
            const [q, setQ] = useState(null);
            const [step, setStep] = useState(1);
            const [servedBurgers, setServedBurgers] = useState([]);
            const [movedBoxes, setMovedBoxes] = useState([]);
            const [inventory, setInventory] = useState({ boxes: 0, burgers: 0 }); 
            const [userAnswer, setUserAnswer] = useState('');
            const [isAnswerCorrect, setIsAnswerCorrect] = useState(null); 
            const inputRef = useRef(null);

            const startLevel = (min, sub) => {
                const minTens = Math.floor(min / 10);
                const minUnits = min % 10;
                const subTens = Math.floor(sub / 10);
                const subUnits = sub % 10;
                const borrow = minUnits < subUnits;
                setQ({ min, sub, minTens, minUnits, subTens, subUnits, borrow });
                setInventory({ boxes: minTens, burgers: minUnits });
                setStep(1);
                setServedBurgers([]);
                setMovedBoxes([]);
                setUserAnswer('');
                setIsAnswerCorrect(null);
                setMode('playing');
            };

            const handleNextLevel = () => {
                if (currentCategory && currentLevelIndex < currentCategory.levels.length - 1) {
                    const nextIndex = currentLevelIndex + 1;
                    setCurrentLevelIndex(nextIndex);
                    startLevel(currentCategory.levels[nextIndex].min, currentCategory.levels[nextIndex].sub);
                } else {
                    audioManager.speak("å¤ªæ£’äº†ï¼åº—é•·ä»»å‹™å…¨éƒ¨å®Œæˆï¼");
                    setMode('category');
                }
            };

            const checkUserAnswer = () => {
                if (!q) return;
                const correctAnswer = q.min - q.sub;
                if (parseInt(userAnswer) === correctAnswer) {
                    setIsAnswerCorrect(true);
                    setStep(7); 
                    audioManager.playSound('success');
                    audioManager.speak(`ç­”å°äº†ï¼å‰©ä¸‹ ${correctAnswer} å€‹æ¼¢å ¡ï¼ä»»å‹™å®Œæˆï¼`);
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                } else {
                    setIsAnswerCorrect(false);
                    audioManager.playSound('error');
                    audioManager.speak("æ•¸é‡ä¸å¤ªå°å–”ï¼Œå†ç®—ç®—çœ‹ï¼");
                    setTimeout(() => setIsAnswerCorrect(null), 1500); 
                }
            };

            useEffect(() => {
                if (mode !== 'playing' || !q) return;
                const answer = q.min - q.sub;

                if(step === 1) audioManager.speak(`æ­¡è¿å…‰è‡¨ï¼å®¢äººè¦è²· ${q.sub} å€‹æ¼¢å ¡ã€‚å€‰åº«æœ‰ ${q.minTens} ç®±ï¼Œæ¶ä¸Šæœ‰ ${q.minUnits} å€‹ã€‚`);
                if(step === 2) {
                    if(q.borrow) audioManager.speak(`æ¶ä¸Šåªæœ‰ ${q.minUnits} å€‹ï¼Œä¸å¤ è³£çµ¦å®¢äººï¼è«‹å»å€‰åº«æ‹†ä¸€ç®±ï¼`);
                    else audioManager.speak(`æ¶ä¸Šæœ‰ ${q.minUnits} å€‹ï¼Œè¶³å¤ äº†ï¼æº–å‚™å‡ºé¤ã€‚`);
                }
                if(step === 3) audioManager.speak("è«‹é»æ“Šä¸€å€‹æ©˜è‰²ç®±å­æŠŠå®ƒæ‹†é–‹ï¼");
                if(step === 4) audioManager.speak(`ç¾åœ¨æ¶ä¸Šæœ‰æ¼¢å ¡äº†ã€‚è«‹é»æ“Š ${q.subUnits} å€‹æ¼¢å ¡çµ¦å®¢äººï¼`);
                if(step === 5) audioManager.speak(`é‚„æœ‰ ${q.subTens} ç®±æ¼¢å ¡è¦è³£ã€‚è«‹é»æ“Š ${q.subTens} å€‹ç®±å­æ¬çµ¦å®¢äººï¼`);
                
                if (step === 6) {
                    audioManager.speak("å‡ºé¤å®Œæˆäº†ï¼è«‹å•é‚„å‰©ä¸‹å¤šå°‘æ¼¢å ¡å‘¢ï¼Ÿè«‹è¼¸å…¥ç­”æ¡ˆã€‚");
                    if(inputRef.current) inputRef.current.focus();
                }

            }, [step, mode, q]);

            const handleOpenBox = () => {
                if (step === 3 && inventory.boxes > 0) {
                    audioManager.playSound('open-box');
                    setInventory(prev => ({ boxes: prev.boxes - 1, burgers: prev.burgers + 10 }));
                    setStep(4);
                }
            };

            const handleServeBurger = (idx) => {
                if (step === 4 && servedBurgers.length < q.subUnits && !servedBurgers.includes(idx)) {
                    setServedBurgers(prev => [...prev, idx]);
                    audioManager.playSound('pop');
                    if (servedBurgers.length + 1 === q.subUnits) {
                        audioManager.speak("æ¼¢å ¡å‡ºé¤å®Œç•¢ï¼");
                        setTimeout(() => setStep(q.subTens > 0 ? 5 : 6), 1000);
                    }
                }
            };

            const handleMoveBox = (idx) => {
                if (step === 5 && movedBoxes.length < q.subTens && !movedBoxes.includes(idx)) {
                    setMovedBoxes(prev => [...prev, idx]);
                    audioManager.playSound('thud');
                    if (movedBoxes.length + 1 === q.subTens) {
                        audioManager.speak("ç®±å­æ¬é‹å®Œç•¢ï¼");
                        setTimeout(() => setStep(6), 1000);
                    }
                }
            };

            if (mode === 'category') return <LevelSelector color={COLORS.burger} onBack={onBack} onLevelSelect={(cat) => { setCurrentCategory(cat); setCurrentLevelIndex(0); startLevel(cat.levels[0].min, cat.levels[0].sub); }} onCustom={() => setMode('input')} />;
            if (mode === 'input') return <CustomInput color={COLORS.burger} onBack={() => setMode('category')} onStart={(min, sub) => { setCurrentCategory(null); startLevel(min, sub); }} />;
            if (!q) return null;

            return (
                <div className={`min-h-screen ${COLORS.burger} p-4 flex flex-col items-center`}>
                    {/* Top Bar */}
                    <div className="w-full max-w-5xl flex justify-between items-center mb-4">
                        <button onClick={() => setMode('category')} className="p-3 bg-white rounded-full shadow hover:bg-gray-50"><Icon name="Home" className="text-orange-600" /></button>
                        
                        <div className="bg-white px-6 py-2 rounded-full shadow-md border-2 border-orange-200 flex items-center gap-3">
                            <span 
                                className="text-orange-800 font-bold tracking-wide"
                                style={{ fontSize: `${1.5 * fontScale}rem` }}
                            >
                                è¨‚å–®: <span className="text-orange-600">{q.min}</span> - <span className="text-red-500">{q.sub}</span> = 
                            </span>
                            <div className="relative">
                                <input 
                                    ref={inputRef}
                                    type="number" 
                                    value={userAnswer}
                                    onChange={(e) => setUserAnswer(e.target.value)}
                                    onKeyDown={(e) => e.key === 'Enter' && checkUserAnswer()}
                                    disabled={step === 7}
                                    style={{ fontSize: `${1.5 * fontScale}rem`, width: `${6 * fontScale}rem`, height: `${3 * fontScale}rem` }}
                                    className={`text-center font-bold border-2 rounded-xl outline-none transition-all
                                        ${isAnswerCorrect === false ? 'border-red-500 bg-red-50 animate-shake' : 
                                        isAnswerCorrect === true ? 'border-green-500 bg-green-50' : 'border-orange-300 focus:border-orange-500'}
                                    `}
                                    placeholder="?"
                                />
                                {step === 7 && <div className="absolute right-[-40px] top-2"><Icon name="CheckCircle2" className="text-green-500" size={32} /></div>}
                            </div>
                            {step !== 7 && (
                                <button onClick={checkUserAnswer} className="bg-orange-500 hover:bg-orange-600 text-white p-2 rounded-lg transition-colors">
                                    <Icon name="Check" size={24} />
                                </button>
                            )}
                        </div>

                        <button onClick={() => audioManager.speak(`è¨‚å–®æ˜¯ ${q.sub} å€‹`)} className="p-3 bg-white rounded-full shadow hover:bg-gray-50"><Icon name="Volume2" className="text-orange-600" /></button>
                    </div>

                    <div className="w-full max-w-4xl bg-white rounded-[2rem] shadow-xl overflow-hidden border-b-8 border-orange-200">
                        <div className="bg-orange-100 p-6 text-center border-b-2 border-orange-200">
                            <h2 className="text-2xl font-bold text-orange-900">
                                {step === 1 ? "æ­¡è¿å…‰è‡¨ï¼" : step === 3 ? "é»æ“Šç®±å­æ‹†é–‹ (å€Ÿä½)" : step === 4 ? `é»æ“Š ${q.subUnits} å€‹æ¼¢å ¡å‡ºé¤` : step === 5 ? `é»æ“Š ${q.subTens} å€‹ç®±å­å‡ºè²¨` : step === 6 ? "è«‹è¼¸å…¥å‰©ä¸‹å¤šå°‘æ¼¢å ¡ï¼Ÿ" : "è¨‚å–®å®Œæˆï¼"}
                            </h2>
                        </div>

                        <div className="p-8 grid grid-cols-1 md:grid-cols-2 gap-8 min-h-[400px]">
                            {/* Warehouse */}
                            <div className="bg-orange-50 rounded-3xl border-4 border-orange-200 p-6 flex flex-col items-center relative">
                                <h3 className="text-orange-800 font-bold mb-6 text-xl flex items-center gap-2"><Icon name="Package" size={20}/> å€‰åº« (1ç®±=10å€‹)</h3>
                                <div className="flex flex-col gap-4 w-full items-center">
                                    <AnimatePresence>
                                        {Array.from({ length: inventory.boxes }).map((_, i) => {
                                            const isMoved = movedBoxes.includes(i);
                                            const isBorrowTarget = step === 3 && i === inventory.boxes - 1;
                                            if (isMoved) return null; 
                                            return (
                                                <motion.button
                                                    key={`box-${i}`}
                                                    initial={{ scale: 0 }} animate={{ scale: 1 }} exit={{ scale: 0 }}
                                                    onClick={() => {
                                                        if (isBorrowTarget) handleOpenBox();
                                                        else handleMoveBox(i);
                                                    }}
                                                    className={`w-40 h-24 bg-amber-600 rounded-xl shadow-lg border-b-8 border-amber-800 flex flex-col items-center justify-center text-white relative
                                                        ${isBorrowTarget ? 'animate-bounce border-yellow-400 border-4' : ''}
                                                        ${step === 5 && !isMoved ? 'hover:bg-amber-500 cursor-pointer' : ''}
                                                    `}
                                                    disabled={!isBorrowTarget && step !== 5}
                                                >
                                                    <Icon name="Package" size={40} />
                                                    {isBorrowTarget && <span className="absolute -top-3 bg-red-500 text-white text-xs px-2 rounded-full">æ‹†é–‹!</span>}
                                                    {step === 5 && movedBoxes.includes(i) && <div className="absolute inset-0 bg-white/50 rounded-xl flex items-center justify-center"><Icon name="Check" className="text-green-600" size={40}/></div>}
                                                    <span 
                                                        className="absolute -bottom-8 left-1/2 -translate-x-1/2 text-amber-200 font-bold pointer-events-none"
                                                        style={{ fontSize: `${1 * fontScale}rem` }}
                                                    >
                                                        {i + 1}
                                                    </span>
                                                </motion.button>
                                            );
                                        })}
                                    </AnimatePresence>
                                </div>
                            </div>

                            {/* Rack */}
                            <div className="bg-white rounded-3xl border-4 border-gray-200 p-6 flex flex-col items-center relative shadow-inner">
                                <h3 className="text-gray-700 font-bold mb-6 text-xl flex items-center gap-2"><Icon name="Coffee" size={20}/> ä¿æº«æ¶ (å€‹ä½)</h3>
                                <div className="grid grid-cols-4 gap-3 w-full content-start flex-1">
                                    <AnimatePresence>
                                        {Array.from({ length: inventory.burgers }).map((_, i) => {
                                            const isServed = servedBurgers.includes(i);
                                            return (
                                                <motion.button
                                                    key={`burger-${i}`}
                                                    initial={{ scale: 0 }} animate={{ scale: 1 }}
                                                    onClick={() => handleServeBurger(i)}
                                                    className={`aspect-square bg-orange-100 rounded-lg flex items-center justify-center text-3xl shadow-sm border border-orange-200 relative
                                                        ${step === 4 && !isServed ? 'hover:bg-orange-200 cursor-pointer' : ''}
                                                    `}
                                                    disabled={step !== 4 || isServed}
                                                >
                                                    ğŸ”
                                                    {isServed && <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="absolute inset-0 flex items-center justify-center bg-white/80 rounded-lg"><Icon name="Check" className="text-green-500" size={32}/></motion.div>}
                                                    <span 
                                                        className="absolute -bottom-8 left-1/2 -translate-x-1/2 text-orange-600 font-bold pointer-events-none"
                                                        style={{ fontSize: `${1 * fontScale}rem` }}
                                                    >
                                                        {i + 1}
                                                    </span>
                                                </motion.button>
                                            );
                                        })}
                                    </AnimatePresence>
                                </div>
                            </div>
                        </div>

                        {/* Action Area */}
                        <div className="bg-gray-50 p-4 flex justify-center border-t-2 border-gray-200 h-24 items-center">
                            {step === 1 && <button onClick={() => setStep(2)} className="bg-blue-500 text-white px-8 py-3 rounded-full font-bold text-xl shadow-lg">é–‹å§‹å‚™é¤</button>}
                            {step === 2 && (q.borrow ? <button onClick={() => setStep(3)} className="bg-red-500 text-white px-8 py-3 rounded-full font-bold text-xl shadow-lg animate-pulse">æ¼¢å ¡ä¸å¤ ï¼æ‹†ç®±å­</button> : <button onClick={() => setStep(4)} className="bg-green-500 text-white px-8 py-3 rounded-full font-bold text-xl shadow-lg">æ¼¢å ¡è¶³å¤ ï¼é–‹å§‹å‡ºé¤</button>)}
                            
                            {step === 4 && (
                                <div className="flex flex-col items-center">
                                    <div className="text-orange-600 font-bold text-xl">å·²å‡ºé¤: {servedBurgers.length} / {q.subUnits}</div>
                                    {servedBurgers.length < q.subUnits && <div className="text-gray-400 font-bold animate-pulse text-sm">è«‹é»æ“Šæ¼¢å ¡...</div>}
                                </div>
                            )}
                            
                            {step === 5 && (
                                <div className="flex flex-col items-center">
                                    <div className="text-orange-600 font-bold text-xl">å·²æ¬ç®±: {movedBoxes.length} / {q.subTens}</div>
                                    {movedBoxes.length < q.subTens && <div className="text-gray-400 font-bold animate-pulse text-sm">è«‹é»æ“Šç®±å­...</div>}
                                </div>
                            )}

                            {step === 6 && (
                                <div className="flex flex-col items-center gap-2 animate-bounce">
                                    <Icon name="ArrowUp" size={40} className="text-purple-500" />
                                    <span className="text-2xl font-bold text-purple-600 bg-white px-4 py-2 rounded-xl shadow-md border-2 border-purple-200">è«‹åœ¨ä¸Šæ–¹è¼¸å…¥ç­”æ¡ˆï¼</span>
                                </div>
                            )}

                            {step === 7 && <button onClick={handleNextLevel} className="bg-green-500 text-white px-8 py-3 rounded-full font-bold text-xl shadow-lg flex items-center gap-2">ä¸‹ä¸€å¼µè¨‚å–® <Icon name="ArrowRight" /></button>}
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const MathAdventure = () => {
            const [currentScreen, setCurrentScreen] = useState('menu');
            const [isMuted, setIsMuted] = useState(false);
            const [fontScale, setFontScale] = useState(1.0);

            useEffect(() => {
                audioManager.isMuted = isMuted;
                if (isMuted && 'speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                }
            }, [isMuted]);

            return (
                <div className="antialiased text-slate-800">
                    <button 
                        onClick={() => setIsMuted(!isMuted)}
                        className="fixed top-4 right-4 z-50 p-3 bg-white/90 backdrop-blur rounded-full shadow-lg border-2 border-slate-200 hover:bg-slate-100 transition-colors"
                    >
                        {isMuted ? <Icon name="VolumeX" className="text-slate-400" /> : <Icon name="Volume2" className="text-blue-500" />}
                    </button>

                    {/* Font Size Slider */}
                    <div className="fixed right-4 top-24 z-50 bg-white/90 backdrop-blur p-4 rounded-full shadow-lg border-2 border-slate-200 flex flex-col items-center gap-2">
                        <Icon name="Type" size={20} className="text-slate-500" />
                        <div className="h-32 flex items-center">
                            <input 
                                type="range" 
                                min="0.8" 
                                max="2.0" 
                                step="0.1" 
                                value={fontScale}
                                onChange={(e) => setFontScale(parseFloat(e.target.value))}
                                className="w-32 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer"
                                style={{ transform: 'rotate(-90deg)', transformOrigin: 'center' }}
                            />
                        </div>
                        <span className="text-xs font-bold text-slate-400">{Math.round(fontScale * 100)}%</span>
                    </div>

                    <AnimatePresence mode="wait">
                        {currentScreen === 'menu' && (
                            <motion.div key="menu" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}>
                                <MainMenu onSelect={setCurrentScreen} />
                            </motion.div>
                        )}
                        {currentScreen === 'story' && (
                            <motion.div key="story" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}>
                                <StoryGame onBack={() => setCurrentScreen('menu')} fontScale={fontScale} />
                            </motion.div>
                        )}
                        {currentScreen === 'burger' && (
                            <motion.div key="burger" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}>
                                <BurgerGame onBack={() => setCurrentScreen('menu')} fontScale={fontScale} />
                            </motion.div>
                        )}
                    </AnimatePresence>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MathAdventure />);
    </script>
</body>
</html>
